<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fleet.Chat Demo</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .fade-out {
            opacity: 0;
            transition: opacity 0.5s ease-out;
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen p-6">
    <div class="max-w-6xl mx-auto">
        <h1 class="text-3xl font-bold text-center mb-8">Fleet.Chat Demo - Bidirectional Communication</h1>
        
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
            <!-- Samsara Panel -->
            <div class="bg-white rounded-lg shadow-lg p-6">
                <h2 class="text-2xl font-semibold mb-4 text-blue-600">üöõ Samsara Fleet Events</h2>
                <p class="text-gray-600 mb-6">Click buttons to send events to drivers</p>
                
                <div class="space-y-4">
                    <div>
                        <button id="route-btn" class="w-full text-left p-4 bg-blue-50 border border-blue-200 rounded-lg hover:bg-blue-100 transition-colors">
                            <div class="flex items-center">
                                <div class="w-10 h-10 bg-blue-500 text-white rounded-full flex items-center justify-center mr-3">üöö</div>
                                <div>
                                    <h3 class="font-semibold">Route Assignment</h3>
                                    <p class="text-sm text-gray-600">Assign new delivery route</p>
                                </div>
                            </div>
                        </button>
                        <div id="route-feedback" class="mt-2"></div>
                    </div>
                    
                    <div>
                        <button id="location-btn" class="w-full text-left p-4 bg-green-50 border border-green-200 rounded-lg hover:bg-green-100 transition-colors">
                            <div class="flex items-center">
                                <div class="w-10 h-10 bg-green-500 text-white rounded-full flex items-center justify-center mr-3">üìç</div>
                                <div>
                                    <h3 class="font-semibold">Location Update</h3>
                                    <p class="text-sm text-gray-600">Request driver location</p>
                                </div>
                            </div>
                        </button>
                        <div id="location-feedback" class="mt-2"></div>
                    </div>
                    
                    <div>
                        <button id="geofence-btn" class="w-full text-left p-4 bg-purple-50 border border-purple-200 rounded-lg hover:bg-purple-100 transition-colors">
                            <div class="flex items-center">
                                <div class="w-10 h-10 bg-purple-500 text-white rounded-full flex items-center justify-center mr-3">üèÅ</div>
                                <div>
                                    <h3 class="font-semibold">Geofence Entry</h3>
                                    <p class="text-sm text-gray-600">Driver arrived at location</p>
                                </div>
                            </div>
                        </button>
                        <div id="geofence-feedback" class="mt-2"></div>
                    </div>
                </div>
            </div>
            
            <!-- WhatsApp Panel -->
            <div class="bg-white rounded-lg shadow-lg p-6">
                <h2 class="text-2xl font-semibold mb-4 text-green-600">üí¨ WhatsApp Driver Messages</h2>
                <p class="text-gray-600 mb-6">Driver communication interface</p>
                
                <div id="whatsapp-chat" class="min-h-96 bg-gray-50 rounded-lg p-4 overflow-y-auto">
                    <div id="initial-message" class="text-center text-gray-500 py-8">
                        <p>No messages yet</p>
                        <p class="text-sm mt-2">Click a Samsara event to see driver messages</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Message templates
        const messageTemplates = {
            route: {
                text: "üöö New Route Assignment\n\nRoute: Berlin ‚Üí Hamburg Express\nPickup: Berlin Distribution Center\nDelivery: Hamburg Port Terminal\n\nPlease confirm receipt.",
                buttons: [
                    { id: "accept", text: "‚úÖ Accept Route" },
                    { id: "details", text: "‚ÑπÔ∏è More Details" },
                    { id: "issue", text: "‚ö†Ô∏è Report Issue" }
                ]
            },
            location: {
                text: "üìç Location Update Request\n\nCurrent position needed for route optimization.\n\nPlease share your location.",
                buttons: [
                    { id: "share", text: "üìç Share Location" },
                    { id: "accurate", text: "‚úÖ Location Accurate" },
                    { id: "gps-issue", text: "‚ö†Ô∏è GPS Issue" }
                ]
            },
            geofence: {
                text: "üèÅ Arrival at Hamburg Port Terminal\n\nArrival detected. Please confirm status.\n\nWhat is your current status?",
                buttons: [
                    { id: "loading", text: "üì¶ Start Loading" },
                    { id: "arrived", text: "üìç Confirm Arrival" }, 
                    { id: "help", text: "üÜò Need Help" }
                ]
            }
        };

        // Response messages
        const responseMessages = {
            accept: "‚úÖ Route accepted! ETA updated.",
            details: "‚ÑπÔ∏è Route details sent to device.",
            issue: "‚ö†Ô∏è Issue reported to dispatch.",
            share: "üìç Location shared: Berlin, Germany",
            accurate: "‚úÖ Location confirmed accurate.",
            "gps-issue": "‚ö†Ô∏è GPS issue reported.",
            loading: "üì¶ Loading started.",
            arrived: "üìç Arrival confirmed.",
            help: "üÜò Assistance requested."
        };

        // Initialize event listeners when page loads
        document.addEventListener('DOMContentLoaded', function() {
            const routeBtn = document.getElementById('route-btn');
            const locationBtn = document.getElementById('location-btn');
            const geofenceBtn = document.getElementById('geofence-btn');
            const whatsappChat = document.getElementById('whatsapp-chat');

            // Add click handlers
            routeBtn.addEventListener('click', function() {
                console.log('Route button clicked');
                sendMessage('route');
            });

            locationBtn.addEventListener('click', function() {
                console.log('Location button clicked');
                sendMessage('location');
            });

            geofenceBtn.addEventListener('click', function() {
                console.log('Geofence button clicked');
                sendMessage('geofence');
            });

            function sendMessage(eventType) {
                console.log('Sending message for event:', eventType);
                const template = messageTemplates[eventType];
                
                // Hide initial message
                const initialMsg = document.getElementById('initial-message');
                if (initialMsg) {
                    initialMsg.style.display = 'none';
                }

                // Create message HTML
                let buttonsHtml = '';
                template.buttons.forEach(function(button) {
                    buttonsHtml += `
                        <button 
                            class="response-btn block w-full text-left px-3 py-2 bg-white border border-gray-300 rounded hover:bg-gray-50 text-sm mb-2 transition-colors"
                            data-response="${button.id}"
                            data-event="${eventType}"
                        >
                            ${button.text}
                        </button>
                    `;
                });

                const messageHtml = `
                    <div class="message-bubble bg-green-100 p-4 rounded-lg mb-4">
                        <p class="whitespace-pre-line text-gray-800">${template.text}</p>
                        <div class="mt-3">
                            ${buttonsHtml}
                        </div>
                        <div class="text-xs text-gray-500 mt-2">${new Date().toLocaleTimeString()}</div>
                    </div>
                `;

                whatsappChat.innerHTML = messageHtml;

                // Add event listeners to response buttons
                const responseButtons = whatsappChat.querySelectorAll('.response-btn');
                responseButtons.forEach(function(btn) {
                    btn.addEventListener('click', function() {
                        const responseId = this.getAttribute('data-response');
                        const eventType = this.getAttribute('data-event');
                        console.log('Response button clicked:', responseId, eventType);
                        handleResponse(responseId, eventType);
                    });
                });
            }

            function handleResponse(responseId, eventType) {
                console.log('Handling response:', responseId, 'for event:', eventType);
                const responseText = responseMessages[responseId] || 'Response sent';
                
                // Add driver response message
                const driverMessageHtml = `
                    <div class="message-bubble bg-blue-100 p-3 rounded-lg mb-4 ml-8">
                        <p class="text-gray-800">${responseText}</p>
                        <div class="text-xs text-gray-500 mt-1">${new Date().toLocaleTimeString()}</div>
                    </div>
                `;

                whatsappChat.innerHTML += driverMessageHtml;
                whatsappChat.scrollTop = whatsappChat.scrollHeight;

                // Show feedback in Samsara panel
                showSamsaraFeedback(eventType, responseText);
            }

            function showSamsaraFeedback(eventType, message) {
                console.log('Showing Samsara feedback for:', eventType, message);
                const feedbackId = eventType + '-feedback';
                const feedbackDiv = document.getElementById(feedbackId);

                const feedbackHtml = `
                    <div class="feedback-panel bg-green-50 border border-green-200 rounded-lg p-3">
                        <div class="flex items-center">
                            <div class="w-6 h-6 bg-green-500 rounded-full flex items-center justify-center mr-3">
                                <span class="text-white text-xs">‚úì</span>
                            </div>
                            <p class="text-sm text-green-800">Driver response: ${message}</p>
                        </div>
                    </div>
                `;

                feedbackDiv.innerHTML = feedbackHtml;

                // Auto-remove after 2 seconds with fade
                setTimeout(function() {
                    const panel = feedbackDiv.querySelector('.feedback-panel');
                    if (panel) {
                        panel.classList.add('fade-out');
                        setTimeout(function() {
                            feedbackDiv.innerHTML = '';
                        }, 500);
                    }
                }, 2000);
            }
        });
    </script>
</body>
</html>